// //frontend/src/pages/FocusMode.jsx
// import { useEffect, useState, useRef } from "react";
// import { api } from "../api";
// import { useAuth } from "../context/AuthContext.jsx";

// function isTodayOrPast(dateStr) {
//   if (!dateStr) return false;
//   const d = new Date(dateStr);
//   const today = new Date();
//   d.setHours(0, 0, 0, 0);
//   today.setHours(0, 0, 0, 0);
//   return d <= today;
// }

// export default function FocusMode() {
//   const { user } = useAuth();
//   const userId = user?.uid;

//   const [tasks, setTasks] = useState([]);
//   const [loading, setLoading] = useState(true);

//   const [secondsLeft, setSecondsLeft] = useState(25 * 60); // 25 min
//   const [isRunning, setIsRunning] = useState(false);
//   const intervalRef = useRef(null);

//   useEffect(() => {
//     if (!userId) return;

//     const fetchTasks = async () => {
//       try {
//         const res = await api.get("/tasks", { params: { userId } });
//         setTasks(res.data);
//       } catch (err) {
//         console.error("FocusMode fetch tasks error:", err);
//       } finally {
//         setLoading(false);
//       }
//     };

//     fetchTasks();
//   }, [userId]);

//   const focusTasks = tasks.filter(
//     (t) => t.status !== "done" && isTodayOrPast(t.dueDate)
//   );

//   const currentTask = focusTasks[0] || null;
//   const remainingTasks = focusTasks.slice(1);

//   const handleMarkDone = async (id) => {
//     try {
//       const res = await api.put(`/tasks/${id}`, { status: "done" });
//       setTasks((prev) => prev.map((t) => (t._id === id ? res.data : t)));
//     } catch (err) {
//       console.error("Mark done error:", err);
//     }
//   };

//   const startTimer = () => {
//     if (intervalRef.current) return;
//     setIsRunning(true);
//     intervalRef.current = setInterval(() => {
//       setSecondsLeft((prev) => {
//         if (prev <= 1) {
//           clearInterval(intervalRef.current);
//           intervalRef.current = null;
//           setIsRunning(false);
//           return 0;
//         }
//         return prev - 1;
//       });
//     }, 1000);
//   };

//   const pauseTimer = () => {
//     setIsRunning(false);
//     if (intervalRef.current) {
//       clearInterval(intervalRef.current);
//       intervalRef.current = null;
//     }
//   };

//   const resetTimer = () => {
//     pauseTimer();
//     setSecondsLeft(25 * 60);
//   };

//   useEffect(() => {
//     return () => {
//       if (intervalRef.current) clearInterval(intervalRef.current);
//     };
//   }, []);

//   const minutes = String(Math.floor(secondsLeft / 60)).padStart(2, "0");
//   const seconds = String(secondsLeft % 60).padStart(2, "0");

//   return (
//     <div className="max-w-4xl mx-auto bg-linear-to-br from-indigo-300 via-purple-200 to-blue-200 p-6">
//       <header className="flex items-center justify-between gap-3">
//         <div>
//           <h1 className="text-2xl font-bold text-indigo-700">
//             Focus Mode
//           </h1>
//           <p className="text-xs md:text-sm text-gray-400 mt-1">
//             See only what matters today. One session at a time.
//           </p>
//         </div>
//         <div className="text-xs md:text-sm text-gray-400">
//           Suggested session:{" "}
//           <span className="text-gray-400 font-medium">25 minutes</span>
//         </div>
//       </header>

//       {/* Current focus task */}
//       {currentTask && (
//         <section className="bg-white border border-gray-200 rounded-2xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
//           <div>
//             <div className="text-[11px] uppercase tracking-wide text-emerald-500 mb-1">
//               Current focus
//             </div>
//             <h2 className="text-sm md:text-base font-semibold text-gray-700">
//               {currentTask.title}
//             </h2>
//             {currentTask.description && (
//               <p className="mt-1 text-[11px] md:text-xs text-gray-500">
//                 {currentTask.description}
//               </p>
//             )}
//             <p className="mt-1 text-[11px] text-gray-900">
//               {currentTask.dueDate
//                 ? `Due: ${new Date(
//                     currentTask.dueDate
//                   ).toLocaleDateString()}`
//                 : "No due date"}
//             </p>
//           </div>
//           <div className="flex gap-2 text-xs">
//             <button
//               onClick={startTimer}
//               className="px-3 py-1.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-medium"
//             >
//               ▶ Start session
//             </button>
//             <button
//               onClick={() => handleMarkDone(currentTask._id)}
//               className="px-3 py-1.5 rounded-xl bg-emerald-600/80 hover:bg-emerald-500 font-medium"
//             >
//               ✓ Mark done
//             </button>
//           </div>
//         </section>
//       )}

//       <div className="grid md:grid-cols-[2fr,1fr] gap-4">
//         {/* Left: other focus tasks */}
//         <div className="bg-white border border-gray-200 rounded-2xl p-4 space-y-3">
//           <h2 className="text-sm font-semibold text-gray-900 mb-1">
//             Today&apos;s & overdue tasks
//           </h2>

//           {loading ? (
//             <div className="text-xs text-gray-500">Loading tasks…</div>
//           ) : focusTasks.length === 0 ? (
//             <div className="text-xs text-gray-900">
//               No due or overdue tasks. You can plan new ones from the dashboard.
//             </div>
//           ) : (
//             <div className="space-y-2 text-xs">
//               {remainingTasks.length === 0 && (
//                 <div className="text-[11px] text-gray-900">
//                   No more tasks after the current one.
//                 </div>
//               )}
//               {remainingTasks.map((task) => (
//                 <div
//                   key={task._id}
//                   className="bg-white border border-gray-200 rounded-xl px-3 py-2.5 flex items-start justify-between gap-3"
//                 >
//                   <div>
//                     <div className="font-medium text-gray-900">
//                       {task.title}
//                     </div>
//                     <div className="mt-1 text-[11px] text-gray-9000">
//                       {task.dueDate
//                         ? `Due: ${new Date(
//                             task.dueDate
//                           ).toLocaleDateString()}`
//                         : "No due date"}
//                     </div>
//                   </div>
//                   <button
//                     onClick={() => handleMarkDone(task._id)}
//                     className="text-[11px] px-2 py-1 rounded-lg bg-emerald-600/80 hover:bg-emerald-500 text-gray-900"
//                   >
//                     Mark done
//                   </button>
//                 </div>
//               ))}
//             </div>
//           )}
//         </div>

//         {/* Right: timer */}
//         <div className="bg-white border border-gray-200 rounded-2xl p-4 flex flex-col items-center justify-center">
//           <div className="text-xs uppercase tracking-wide text-gray-500 mb-2">
//             Focus Session
//           </div>
//           <div className="text-4xl md:text-5xl font-semibold text-gray-600">
//             {minutes}:{seconds}
//           </div>
//           <p className="mt-2 text-[12px] text-gray-600 text-center">
//             Start a deep work sprint. Avoid switching tabs until the timer ends.
//           </p>
//           <div className="mt-4 flex gap-2">
//             <button
//               onClick={startTimer}
//               className="px-4 py-1.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-xs font-medium"
//             >
//               ▶ {isRunning ? "Running" : "Start"}
//             </button>
//             <button
//               onClick={pauseTimer}
//               className="px-4 py-1.5 rounded-xl border border-gray-300 text-xs text-gray-200 hover:border-gray-500"
//             >
//               ⏸ Pause
//             </button>
//             <button
//               onClick={resetTimer}
//               className="px-4 py-1.5 rounded-xl border border-gray-300 text-xs text-gray-200 hover:border-gray-500"
//             >
//               ⟲ Reset
//             </button>
//           </div>
//         </div>
//       </div>
//     </div>
//   );
// }
import { useEffect, useState, useRef } from "react";
import { api } from "../api";
import { useAuth } from "../context/AuthContext";
import { motion } from "framer-motion";

function isTodayOrPast(dateStr) {
    if (!dateStr) return false;
    const d = new Date(dateStr);
    const today = new Date();
    d.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    return d <= today;
  }

export default function FocusMode() {
  const { user } = useAuth();
  const uid = user?.uid;

  const [tasks, setTasks] = useState([]);
  const [seconds, setSeconds] = useState(1500);
  const [loading, setLoading] = useState(true);
  const [running, setRunning] = useState(false);
  const timer = useRef(null);
  const intervalRef = useRef(null);

  useEffect(() => {
    if (!uid) return;

    const fetchTasks = async () => {
      try {
        const res = await api.get("/tasks", { params: { userFirebaseUid: uid } });
        setTasks(res.data);
      } catch (err) {
        console.error("FocusMode fetch tasks error:", err);
      } finally {
        setLoading(false);
      }
    };

    fetchTasks();
  }, [uid]);

  const focusTasks = tasks.filter(
    (t) => t.status !== "done" && isTodayOrPast(t.dueDate)
  );
  const current = tasks.find((t) => t.status !== "done");
  const remainingTasks = focusTasks.slice(1);

  const handleMarkDone = async (id) => {
    try {
      const res = await api.put(`/tasks/${id}`, { status: "done" });
      setTasks((prev) => prev.map((t) => (t._id === id ? res.data : t)));
    } catch (err) {
      console.error("Mark done error:", err);
    }
  };

  const start = () => {
    if (timer.current) return;
    setRunning(true);
    timer.current = setInterval(() => {
      setSeconds((s) => {
        if (s <= 1) {
          clearInterval(timer.current);
          timer.current = null;
          setRunning(false);
          return 0;
        }
        return s - 1;
      });
    }, 1000);
  };

  const stop = () => {
    clearInterval(timer.current);
    timer.current = null;
    setRunning(false);
  };

  const resetTimer = () => {
    stop();
    setSeconds(25 * 60);
  };
  useEffect(() => {
    const interval= intervalRef.current;
    return () => {
      if (interval) clearInterval(interval);
    };
  }, []);

  return (
    <div className="min-h-screen bg-linear-to-br from-indigo-300 via-purple-200 to-blue-200 p-6">
      <motion.div
        initial={{ opacity: 0, y: 15 }}
        animate={{ opacity: 1, y: 0 }}
        className="max-w-5xl mx-auto space-y-4"
      >
        <h1 className="text-2xl font-bold text-indigo-700">
          Focus Mode
        </h1>

        <div className=" backdrop-blur-xl bg-white/40 rounded-2xl p-6 text-center">
          <div className="text-5xl font-semibold text-indigo-600">
            {String(Math.floor(seconds / 60)).padStart(2, "0")}:
            {String(seconds % 60).padStart(2, "0")}
          </div>

          <div className="mt-4 flex justify-center gap-3">
            <motion.button
              whileHover={{ scale: 1.02 }}
              whileTap={{ scale: 1 }}
              onClick={start}
              className="rounded-xl px-6 py-2 bg-indigo-600 hover:bg-indigo-400 font-medium transition cursor-pointer"
            >
              Start
            </motion.button>
            <motion.button
              whileHover={{ scale: 1.02 }}
              whileTap={{ scale: 1 }}
              onClick={stop}
              className="px-6 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-400 font-medium transition cursor-pointer"
            >
              Pause
            </motion.button>
            <motion.button
              whileHover={{ scale: 1.02 }}
              whileTap={{ scale: 1 }}
              onClick={resetTimer}
              className="px-6 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-400 font-medium transition cursor-pointer"
            >
              Reset
            </motion.button>
          </div>
        </div>

        {current && (
        <section className="bg-white/40 rounded-2xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div className="text-sm font-semibold flex items-center gap-2 tracking-wide text-emerald-500 mb-3">
              Current focus
            </div>
            <div className="font-medium text-indigo-500 text-sm">
                  {current.title}
                </div>
            {current.description && (
              <p className="text-xs text-indigo-500 mt-1">
                {current.description}
              </p>
            )}
            <p className="mt-2 text-xs text-gray-500">
              {current.dueDate
                ? `Due: ${new Date(
                    current.dueDate
                  ).toLocaleDateString()}`
                : "No due date"}
            </p>
          </div>
          <div className="flex gap-2 text-xs">
            <button
              onClick={start}
              className="px-3 py-1.5 rounded-xl bg-indigo-600 hover:bg-indigo-400 font-medium transition cursor-pointer"
            >
              Start session
            </button>
            <button
              onClick={() => handleMarkDone(current._id)}
              className="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-400 font-medium transition cursor-pointer"
            >
              Mark done
            </button>
          </div>
        </section>
        )}
        <section className="bg-white/40 rounded-2xl p-4">
           <h2 className="text-sm font-bold text-gray-700 flex items-center gap-2 mb-3">
             TODAY&apos;S & OVERDUE TASKS
           </h2>

           {loading ? (
            <div className="text-xs text-gray-500">Loading tasks…</div>
          ) : focusTasks.length === 0 ? (
            <div className="text-xs text-gray-500">
              No due or overdue tasks. You can plan new ones from the dashboard.
            </div>
          ) : (
            <div className="space-y-2 text-xs">
              {remainingTasks.length === 0 && (
                <div className="text-[11px] text-gray-500">
                  No more tasks after the current one.
                </div>
              )}
              {remainingTasks.map((task) => (
                <div
                  key={task._id}
                  // className="bg-white/60 border border-gray-200 rounded-xl px-3 py-2.5 flex items-start justify-between gap-3"
                  className="border border-indigo-600/60 bg-indigo-200 rounded-xl px-3 py-2 flex items-center justify-between cursor-pointer hover:border-indigo-600/60 hover:bg-indigo-300 transition"
                >
                  <div>
                    <div className="font-medium text-sm text-gray-800 flex items-center gap-3 py-1">
                      {task.title}
                    </div>
                    <div className="text-[10px] text-gray-600">
                      {task.dueDate
                        ? `Due: ${new Date(
                            task.dueDate
                          ).toLocaleDateString()}`
                        : "No due date"}
                    </div>
                  </div>
                  <button
                    onClick={() => handleMarkDone(current._id)}
                    className="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-400 font-medium transition cursor-pointer"
                  >
                    Mark done
                  </button>
                </div>
              ))}
            </div>
          )}
        </section>
      </motion.div>
    </div>
  );
}
